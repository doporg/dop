# v1版本残留问题

### 整体  
1. All In Kubernetes: 将所有的服务、工具、基础设施均部署到Kubernetes中以提高资源利用率、可用性、可靠性  
   1. Jenkins  
   2. Harbor  
   3. GitLab  
   4. RocketMQ  
2. 底层存储设施的高可靠和高可用: 当前所有的存储直接挂在在系统文件中, 容易丢失/损坏, 当All In Kubernetes后可使用ceph作为存储, 提高系统可靠性.  
3. istio支持, 当前已经部署使用, 但上个迭代应用管理模块时间紧迫未能将其在应用层暴露出来  
   1. 支持istio, 并对接负责监控模块的同学  
   2. 应用管理模块支持蓝绿发布配置  
4. 各个业务管理模块未进行很好的权限控制, 当前只有应用管理模块接入了权限控制, 但只有一个角色. 每个模块都应有完整的角色/权限(数据权限和功能权限控制)控制, 保证用户能做自己可以做的事, 操作自己可以操作的数据.  
  
### 应用管理模块  
  
1. istio->蓝绿发布（权重）
2. 完善权限管理  
3. 对接监控模块  
  
### 流水线管理模块  
  
1. 功能权限、数据权限  
2. 流水线回放  
3. 流水线之间手动流转  
4. 红线  
5. 主动终止流水线  

### 测试模块
当前仅仅为接口测试

# v2版本新增功能

### 监控模块

监控和历史报表了解当前服务实例的性能、JVM监控，提供链路分析
全局应用基础数据和监控数据、告警等数据报表，帮助用户进行态势分析，显示当前过去的24h 数据。

基础数据显示：显示当前平台的网关 API 、当前服务数、当前实例数、中间件；

外部请求数：显示24h 内有多少请求访问网关，及访问后的状态码分析和满意度（平均响应时间）统计；
外部IP 数：显示24h 内来源的IP 数及每个事件刻度下IP 数；
平台告警：显示24h 内告警总次数；


所属服务：当前实例属于哪一个服务的运行体；
实例名称：实例的instanceId 信息；
实例状态：实例的status ，包含：UP、DOWN；
运行时长：当前时间距离实例注册开始时间的时间差；
内存使用：已使用的内存/被分配的内存；
<img width="1439" alt="1" src="https://user-images.githubusercontent.com/17808702/64095408-4ac6b800-cd91-11e9-9215-66c5836a2bce.png">

##### 难点
1.  两种istio多集群链接方式都需要**对用户集群进行istio配置**
![TIM截图20190903100705](https://user-images.githubusercontent.com/17808702/64139232-ba40b400-ce32-11e9-813f-6546b10ee7cc.png)
![TIM截图20190903100722](https://user-images.githubusercontent.com/17808702/64139233-ba40b400-ce32-11e9-90ae-4d7478aab5be.png)
2. 采用promethus方式需要对**用户代码**进行更改，且不能进行istio api网关层面的管控

### 告警模块
监控数据到达阈值时对联系人进行邮件通知。

状态：配置策略的执行与暂停执行；
告警级别：策略重要性标示，包括：一般、严重；

**告警规则配置**
指标：需要告警的指标信息，详情请参见》告警指标列表
条件：对监控的“指标”值的判断条件，包括：>、<、=、>=、<=;
阈值：“指标”根据告警条件触发告警事件的临界值；
统计周期：统计多少时间范围内的指标·数据；
重复次数：“指标”达到“阈值”发生了多少次，由于会因为网络原因，会出现抖动情况，可以配置允许多次达到阈值之后才进行告警事件通知。

添加多个**告警“实例”**

接收人：发生告警事件后需要通知的人员信息；
通知方式：邮件
通知间隔：发生告警事件后，如果再次发生相同规则的告警时间，在通知间隔的时间内不再持续通知，避免通知重复，影响造成重要信息查看；
**历史记录**

<img width="1439" alt="1" src="https://user-images.githubusercontent.com/17808702/64095953-e6a4f380-cd92-11e9-8783-89ca2cd7ddb3.png">
<img width="1200" alt="2" src="https://user-images.githubusercontent.com/17808702/64095955-e73d8a00-cd92-11e9-891a-60c9b2f727b9.png">
<img width="1195" alt="3" src="https://user-images.githubusercontent.com/17808702/64095956-e73d8a00-cd92-11e9-9dec-8542a5df8cc8.png">
<img width="1199" alt="4" src="https://user-images.githubusercontent.com/17808702/64095957-e7d62080-cd92-11e9-83ef-85b23a77c15a.png">
<img width="1196" alt="5" src="https://user-images.githubusercontent.com/17808702/64095958-e7d62080-cd92-11e9-9487-489227626fee.png">
<img width="1166" alt="6" src="https://user-images.githubusercontent.com/17808702/64095959-e86eb700-cd92-11e9-844a-3b21ca2eb4c5.png">


### API网关

 **流量统计**可查看一段时间内网关整体的请求转发情况，以统计报表形式展现api

请求数：柱状图显示网关在选定时间内的总体请求数情况，体现总体请求的成功数，失败数，平均耗时；
吞吐量：显示网关整体请求的吞吐量；
错误率：显示网关整体请求的错误率；
高频API：显示网关中被频繁调用的API（前5）；  
调用错误率最高的API（前5）；  
调用耗时最久的API（前5）；
状态码分析：饼图显示，网关中所有API调用返回的状态码的比例 ；
<img width="809" alt="2" src="https://user-images.githubusercontent.com/17808702/64095566-ae50e580-cd91-11e9-927a-8e092a31eb21.png">

显示API网关中API接口的**请求日志信息**
**API管理**
<img width="1439" alt="4" src="https://user-images.githubusercontent.com/17808702/64095595-cfb1d180-cd91-11e9-95db-7f1844284b2f.png">

API处理时间超出设定时间

**熔断**用于对访问出现大量失败的 API 进行熔断控制，阻止请求对 API 的访问
“熔断检测环大小”：指校验环内的请求数的数量，如设置：2000；
“临界熔断失败率”：用于判断API 是否达到熔断条件，如设置：30%；
“熔断持续时间”： API 在熔断后修复的一段时间，如设置：1000s；
注：此时的API 不可访问；
“恢复检测环大小”：需要检测API 新的请求过来是否恢复正常，如设置：800，
由以上知：
1. 请求数充满2000的环内，判断（环内失败数／2000）是否大于等于  “临界熔断失败率”，如果大于等于，API 处于“熔断中”，否则 API 为“健康”状态；

2. 熔断持续1000s后，系统再次检测：（恢复检测环失败数／2000）是否大于等于“临界熔断失败率”，如果大于等于，API 再次进入  “熔断中”状态，否则， API 为“健康”状态，接受所有请求访问；

**流控策略**
限制API 在一段时间内的请求次数
限制API 单位时间内被请求的最大上限次数


问题：实验室内部使用为什么不先在单集群内部使用？