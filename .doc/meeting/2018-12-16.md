# 1.CheckList

0. 是否有人想只写前端？

>如果只写前端可以写多个项目的前端然后给分一个模块作为毕设

1. 是否考研？
   * 王舒瑶：不考研
   * 曾锡豪：不考研
   * 辛志庭：考研
   * 郑博文：保研
   * 李质颖：保研

2. 能进行项目的时间？
   * 王舒瑶：2019-01-20~2019-04-20
   * 曾锡豪：2019-02-15~2019-04-20
   * 辛志庭：2019-01-01~2019-03-15
   * 任贵杰：一直
   * 张富利：一直
   * 郑博文：2019-02-25~2019-05-20
   * 李质颖：2019-02-25~2019-05-20

3. 已掌握技能，项目背景（服务端&前端，如果每个人都会前端或服务端可以全站开发）
   * 王舒瑶：学校项目，Java相关，了解前端。
   * 曾锡豪：美团实习，配置管理中心。阿里实习，权限管理。Java相关。
   * 辛志庭：学校项目，课程设计，偏重后端。手撸JS
   * 任贵杰：
   * 张富利：VUE，Spring。学校和实习，前端项目
   * 郑博文：课设，Java、数据库课设，算法（深度学习），写过微信小程序，Spring相关没用过。
   * 李质颖：课设，Java、数据库课设，算法（深度学习），Spring相关没用过。

4. 是否实习过，体验过企业实际开发流程、使用过CI相关工具？
   * 王舒瑶：无
   * 曾锡豪：是
   * 辛志庭：无
   * 任贵杰：是
   * 张富利：无
   * 郑博文：无
   * 李质颖：无

5. GitFLow，是否用过？（[git资料](../material/git.md)）
   * 在自己的feature分支编写代码并commit
   * master分支为保护分支
   * 创建pull request提交合并请求，code review后将代码合入master分支

6. 谁进行code review
   * 暂定任贵杰后端、张富利前端？

7. 部署环境（待解决）
   * 当前资源有限只能部署一套稳定环境，且在公有云环境下，导致本地运行的服务可能无法调用eureka上其他服务，所以涉及到服务间调用的可本地启动多个服务或另外部署一套全部服务暴露在外网的服务。

8. 服务器资源（尽量在同一内网环境下，约需要3台8G服务器）
   * gitlab运行最低需要2C4G服务器
   * Jenkins运行需要2C4G服务器
   * Harbor暂不确定
   * K8S运行+DOP的各个服务需要 2*8G服务器

9.  期望做的模块（根据已掌握技能、个人时间讨论决定）
    * 王舒瑶：测试，项目管理
    * 曾锡豪：测试，权限
    * 辛志庭：流水线，镜像
    * 张富利：流水线，登录

10. 近7天计划，做一些开始写代码前的准备工作
    * 任贵杰
      * 创建服务端项目，统一项目目录，返回值(会打一个jar放到maven中央仓库，统一使用这个jar中的断言、返回值)，编程规范，demo代码等。
      * 创建无OAuth2和用户认证的API网关，进行简单的请求转发
      * 研究gitlab和jenkins的登录模块，设计DOP的统一登录模块
    * 张富利
      * 创建前端项目，同一目录，编程规范等。
      * 对前端进行统一的布局、路由设计，其他同学直接在子路由中开发对应的component（比如流水线管理的UI）
      * 前端，对接OAuth2认证流程
      * 是否想写服务端？在API网关中写OAuth2的服务端流程
    * 所有其他人
      * 了解项目目录，各种框架的基本用法（前端、服务端），写些增删改查的小demo
      * 熟悉自己选的模块所涉及的功能，思考如何设计、实现
        * 提供足够灵活度（用户可定制化）的同时又便于使用（封装什么、抽象什么、暴露什么）
        * 未来能够方便的扩展（比如前面jenkins pipline中 部署时使用脚本调用kubernetes部署就是可扩展性很差的方式）
        * 思考自身模块与哪些模块有关联？如何与其他模块关联，比如项目管理与流水线，流水线与测试管理
      * 熟悉自己所选模块涉及的开源工具并实际使用，了解工具涉及的概念、数据模型，比如：
        * 流水线：使用jenkins pipline并验证其各种特性
        * 测试：了解OpenAPI；不同类型的测试工具，如gatling、Jacoco等，思考如何统一不同测试工具的数据模型；如何隔离资源。
        * 应用管理：使用kubernetes，了解k8s rest api，了解istio等等
11. 是否有人做K8S，Istio相关的东西，能否统一基础的服务和页面？
12. 域名？
13. 飞冰？reactjs or vuejs
14. 需要什么基础的模块（比如mongodb,MQ,MYSQL）随时提，我们统一部署，然后将信息公布在[URL资料](../material/url.md)

# 2.Introduction

* 目的开发一个DevOps平台

## 2.1.简单CI流程

![image](http://clsaa-big-data-notes-1252032169.cossh.myqcloud.com/2018-12-15-CI.png)

* **用户故事**
  * 背景：产品迭代速度越来越快，研发团队需要一套高度自动化的工具帮助工程师完成代码提交->构建->测试->发布等一系列工作。
  * **研发团队**：微型业务后台团队，使用Git进行代码管理，使用Java进行项目开发，最终交付产物为服务/War/Jar,交付方式是使用Docker交付，部署在K8S集群上。暂时不包括云主机部署、ReactNative交付
  * **流水线需求**：整个持续交付流水线的需求如下图所示：![image](http://cloud-computing-notes-img-bed-1252032169.cossh.myqcloud.com/2018-11-11-142524.png)**整个过程可以大致描述为**：代码合并到 master 后能够自动触发对应的集成编译，如编译通过则部署到对应的测试环境下，部署成功后驱动自动化测试，测试通过则分批部署到生产环境。主体流水线发生的状态变更，都需要通过 E-mail 通知发起人。这里的发起人就是代码提交者和合并审核人。
  * **代码与配置管理相关的需求**：团队的代码分支策略均采用标准的 GitLab Flow 模型，要求是代码通过 code review 后才能合并入 master 分支；合并入 master 分支后，能够触发对应的集成编译。同时，需要代码静态扫描服务，帮助我们更好地把控代码质量。这个服务的具体工作形式是：因为代码扫描是异步处理的，所以扫描过程将在代码编译通过之后开始。而扫描结果，则作为是否可继续流水线的依据。**这里需要注意的是，整个代码扫描过程是异步进行的，所以在没有得到扫描结果前，主体流水线将继续进行**。如果主体流水线已经执行完，而代码扫描还没结束，也就是还没有得到扫描结果的话，整条流水线需要停下来等待；而如果在执行主体流水线的过程中，代码静态扫描的结果是不通过的话，那么就需要直接中断主体流水线的执行，此次交付宣告失败。
  * **构建与集成相关的需求**：
    * 首先，能够同时**支持Docker镜像的编译和集成**。而且能够在**触发编译时自动进行适配支持**，这样才能保证各个团队有新项目时无须再进行额外配置。
    * 其次，**所有构建产物及构建历史，都能被有效、永久地记录和存储**。因为单从传统的编译驱动管理角度看，它以编译任务为基准，需要清除过久、过大的编译任务，从而释放更多的资源用于集成编译。但是，从持续交付的角度看，我们需要完全保留这些内容，用于版本追溯。
    * 再次，各**构建产物有自己独立的版本体系，并与代码 commit ID 相关联**。这是非常重要的，交付产物的版本就是它的唯一标识，任何交付物都可以通过版本进行辨识和追溯。
    * 最后，**构建通道必须能够支持足够的并发量**。这也就要求集成构建服务要做到高可用和可扩展，最好能做到资源弹性利用。
  * **打包与发布相关的需求**
    * 从团队交付产物的角度来看，他们需要的环境可以描述如下：测试服务器需要 1 个集群，2 个 Docker 实例；生产环境需要 2 个集群，各 7 个 Docker 实例。
    * 另外，为了发布过程更加可控，需要对代码目录、进程管理、日志格式等进行统一的标准化。
  * **自动化测试的需求**
    * 在这里，自动化测试平台可选择TestNG对于测试，系统需要注意的是，不要有一个测试任务失败就中断交付，最好是跑完所有测试任务，并收集结果。
    * 当然，我们也需要在处理自动测试过程中的异常情况，比如测试脚本出现死循环我们要有超时终止机制应对。

* 流水线管理？

![image](http://clsaa-big-data-notes-1252032169.cossh.myqcloud.com/2018-12-15-100410.png)

![image](http://clsaa-big-data-notes-1252032169.cossh.myqcloud.com/2018-12-15-101017.png)

## 2.2.JenkinsPipline

http://jenkins.clsaa.com

http://gitlab.clsaa.com

https://k8s.clsaa.com:30001

* 代码:Pipeline以代码的形式实现，通常被检入源代码控制，使团队能够编辑、审查和迭代其CD流程
* 可持续性：Jenklins重启或者中断后都不会影响Pipeline Job
* 停顿：Pipeline可以选择停止并等待任工输入或批准，然后再继续Pipeline运行
* 多功能：Pipeline支持现实世界的复杂CD要求，包括fork/join子进程，循环和并行执行工作的能力
* 可扩展：Pipeline插件支持其DSL的自定义扩展以及与其他插件集成的多个选项


```groovy
#!/groovy
pipeline{
	agent any

	environment {
		REPOSITORY="http://gitlab.clsaa.com/clsaa/njuqa-server.git"
		MODULE="njuqa-server"
		SCRIPT_PATH="/root/.jenkins/scripts"
	}

	stages {
		stage('pull code') {
			steps {
				echo "start fetch code from git:${REPOSITORY}"
				deleteDir()
				git "${REPOSITORY}"
			}
		}

		stage('代码静态检查') {
			steps {
				echo "start code check"
			}
		}

		stage('build maven') {
			steps {
				echo "star compile & test"
				sh "ls"
				sh "mvn clean test package"
			}
		}

		stage('build docker') {
			steps {
				echo "start build image"
				sh "${SCRIPT_PATH}/build-images.sh ${MODULE}"
			}
		}

		stage('deploy') {
			steps {
				echo "start deploy"
				sh "${SCRIPT_PATH}/deploy.sh ${MODULE} ${MODULE}"
			}
		}
	}
}
```


## 2.3.应用管理

![image](http://clsaa-big-data-notes-1252032169.cossh.myqcloud.com/2018-12-15-112407.png)

![image](http://clsaa-big-data-notes-1252032169.cossh.myqcloud.com/2018-12-15-112432.png)

![image](http://clsaa-big-data-notes-1252032169.cossh.myqcloud.com/2018-12-15-112517.png)

## 2.4.测试管理

* 测试管理的测试任务可在流水线中进行调用，以完成一次回归测试、冒烟测试、压力测试等

![image](http://clsaa-big-data-notes-1252032169.cossh.myqcloud.com/2018-12-15-114459.png)


# 3.ARCHITECTURE OF DOP

![image](http://clsaa-big-data-notes-1252032169.cossh.myqcloud.com/2018-12-15-ArchitectureOfDop.png)

# 4.待确认问题

1. 服务器资源
2. 和重庆大学两个同学联系

我和杉杉姐比较期望 我们实验室自己学生能选 测试服务、项目管理服务，但它们比较难，需要你们投入的时间和精力也很大。 如果你们觉得自己搞不定， 就选项目管理服务和权限服务。 如果觉得自己就想水水，就选代码管理服务和权限服务。   

每个人选两个 按优先级递减排序，明天晚上六点之前发给我。  你们两个之间尽量商量下优先级高的不要相互冲突，比如一个人选 测试服务、权限服务  另一个人选 测试服务、代码管理服务。这样你们必然有一个人会被分去做优先级低的模块